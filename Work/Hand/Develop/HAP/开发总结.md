# 数据库层操作

## Mybatis批量操作

- **批量删除**

```XML
<delete id="deleteBatch">
    <if test="list != null and list.size>0">
        delete from puma_employee_basic where employee_no in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.employeeNo}
        </foreach>
    </if>
</delete>
```

- **批量插入**

```xml
<insert id="insertBatch" useGeneratedKeys="true" keyProperty="unitId">
        <if test="list != null and list.size > 0">
            INSERT INTO csh_repayment_register_head_itf(UNIT_CODE
          ,CREATED_BY,CREATION_DATE,LAST_UPDATED_BY,LAST_UPDATE_DATE,OBJECT_VERSION_NUMBER,REQUEST_ID,PROGRAM_ID,LAST_UPDATE_LOGIN) VALUES
            <foreach collection="list" item="item" index="index" separator=",">
                (#{item.unitCode},#{request.userId} ,now() ,#{request.userId},now() ,1 ,null ,null ,#{request.userId})
            </foreach>
        </if>
    </insert>
```

- **批量更新**

```xml
<update id="updateBatch">
        <if test="positionList != null and positionList.size > 0">
            <foreach collection="positionList" item="position" index="index" separator=";">
                update exp_org_position
                set POSITION_ID = IFNULL(#{position.positionId},POSITION_ID)
                ,UNIT_ID = IFNULL(#{position.unitId},UNIT_ID)
                ,POSITION_CODE = IFNULL(#{position.positionCode},POSITION_CODE)
                ,DESCRIPTION = IFNULL(#{position.description},DESCRIPTION)
                ,PARENT_POSITION_ID = IFNULL(#{position.parentPositionId},PARENT_POSITION_ID)
                ,COMPANY_ID = IFNULL(#{position.companyId},COMPANY_ID)
                ,EMPLOYEE_JOB_ID = IFNULL(#{position.employeeJobId},EMPLOYEE_JOB_ID)
                ,ENABLED_FLAG = IFNULL(#{position.enabledFlag},ENABLED_FLAG)
                ,LAST_UPDATED_BY =  #{request.userId}
                ,LAST_UPDATE_DATE = now()
                ,OBJECT_VERSION_NUMBER = OBJECT_VERSION_NUMBER + 1
                WHERE 1=1
                AND POSITION_CODE = #{position.positionCode}
                AND OBJECT_VERSION_NUMBER = #{position.objectVersionNumber}
            </foreach>
        </if>
    </update>
```

- 批量查询

```xml
 <select id="selectBatch" resultType="com.hand.hssp.fnd.dto.FndDimensionValue">
        SELECT
    DIMENSION_VALUE_ID,DIMENSION_ID,DIMENSION_VALUE_CODE,DESCRIPTION,SUMMARY_FLAG,ENABLED_FLAG,
        CREATED_BY,CREATION_DATE,LAST_UPDATED_BY,LAST_UPDATE_DATE,OBJECT_VERSION_NUMBER,REQUEST_ID,PROGRAM_ID,
        LAST_UPDATE_LOGIN
        FROM
        fnd_dimension_value f
        <where>
            1=1
            <if test="list != null and list.size()>0">
                AND
                <foreach collection="list" item="item" index="index" open="(" close=")"
                         separator="or">
                    (f.DIMENSION_VALUE_CODE=#{item.dimensionValueCode}
                    and f.DIMENSION_ID = #{item.dimensionId})
                </foreach>
            </if>
        </where>
    </select>
```



## 错误合集

- ```shell
  nested exception is org.apache.ibatis.binding.BindingException: Parameter '__frch_item_0' not found. Available parameters are [collection, list]
  ```

  - 查看parameterType的类型是不是Java.util.List类型
  - 看foreach的collection属性是不是list
  - 看foreach里取的属性值是否写错，大小写是否相同
  - 查看foreach里取的属性值实体对象中是否存在

## 数据库脚本

```sql
--根据表名查出对应字段列表
SELECT GROUP_CONCAT(C.COLUMN_NAME SEPARATOR ',') FROM information_schema.COLUMNS C WHERE C.TABLE_NAME = 'puma_executive_dept_basic' group by table_name;
--查询出插入字段列表
SELECT lower(GROUP_CONCAT(concat('#{item.',C.COLUMN_NAME,'}') SEPARATOR ',')) FROM information_schema.COLUMNS C WHERE C.TABLE_NAME = 'puma_executive_dept_basic' group by table_name;
--查询出update字段列表
SELECT GROUP_CONCAT(C.COLUMN_NAME,' = ','IFNULL(#{item.',lower(C.COLUMN_NAME),'},',C.COLUMN_NAME,'),
' SEPARATOR '') FROM information_schema.COLUMNS C WHERE C.TABLE_NAME = 'puma_position_basic';
--group_concat查询出来长度被限制
SHOW VARIABLES LIKE "group_concat_max_len"; #查询最大值
 SHOW VARIABLES LIKE '%max_allowed_packet%';
SET GLOBAL group_concat_max_len=1024000;
SET SESSION group_concat_max_len=1024000;
```

## 在线工具

[下划线转驼峰](https://www.bejson.com/convert/camel_underscore/)

# 应用层操作

```java
BeanUtils.copyProperties();//复制类
HecUtil//hec工具类
```

```java
//java拼接sql
Example example = new Example(CshPaymentMethod.class);
Example.Criteria criteria = example.createCriteria();
criteria.andEqualTo(CshPaymentMethod.FIELD_ENABLED_FLAG, BaseConstants.YES);
criteria.andIn(CshPaymentMethod.FIELD_PAYMENT_METHOD_CODE, paymentMethods);
cshPaymentMethodMapper.selectByExample(example);
//service 拼接查询条件
IRequest requestContext = createRequestContext(request);
Criteria criteria = new Criteria(dto);
criteria.where(new WhereField(GldUsageCode.FIELD_USAGE_CODE, Comparison.LIKE));
criteria.where(new WhereField(GldUsageCode.FIELD_DESCRIPTION, Comparison.LIKE));
service.selectOptions(requestContext,dto,criteria,page,pageSize);
//查询单个数据
ExpOrgPosition expOrgPosition = expOrgPositionMapper.selectOne(ExpOrgPosition.builder().positionCode(headinfer.getPositionCode()).build());
```

