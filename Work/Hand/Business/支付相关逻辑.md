# 单据支付

- Controller入口

```ruby
CshDocPayAccEntityController.payment
```

- service入口

```ruby
CshDocPayServiceImpl.executePayment
```



 		## 返回付款现金事物

### 报销单

#### 	生成现金事物头

​		**现金事物头表：**`csh_transaction_header`

| 字段               | 字段值                    | 字段描述                        |
| ------------------ | ------------------------- | ------------------------------- |
| TRANSACTION_TYPE   | PAYMENT                   | 现金事物类型                    |
| POSTED_FLAG        | N                         | 过账标志                        |
| GLD_INTERFACE_FLAG | 支付方式为网银/报盘？H：P | 总账标志（N未入总账\\P可入总账) |
#### 	生成现金事物行 

​		**现金事物行表：** `csh_transaction_line`

| 字段                  | 字段值 | 字段描述       |
| --------------------- | ------ | -------------- |
| PAYEE_BANK_ACCOUNT_ID | NULL   | 收款方银行账户 |

#### 	生成核销记录

​		**核销记录表:** `csh_write_off`

| 字段                    | 字段值                                 | 字段描述                      |
| ----------------------- | -------------------------------------- | ----------------------------- |
| CSH_TRANSACTION_LINE_ID |                                        | 现金事务行ID                  |
| WRITE_OFF_TYPE          | 付款核销报销单(PAYMENT_EXPENSE_REPORT) | 核销类型 (CSH_WRITE_OFF_TYPE) |
| DOCUMENT_SOURCE         | EXPENSE_REPORT(费用报销单)             | 单据来源                      |
| GLD_INTERFACE_FLAG      | P                                      | 总账标识                      |

​		**单据现金事务关联表:** `csh_transaction_ref_doc`



#### 	现金事物过账

​		`CshTransactionServiceImpl.postTransaction`

- 支付逻辑`CshWriteOffServiceImpl.executePayment`

  - 单据支付``CshWriteOffServiceImpl.reportPayment`(报销单支付)

    - 插入上面生成的核销记录

    - 生成付款凭证`csh_transaction_account`

      | 字段                | 字段值                                                       | 字段描述 |
    | ------------------- | ------------------------------------------------------------ | -------- |
      | TRANSACTION_LINE_ID | 现金事物行ID                                                 |          |
    | WRITE_OFF_ID        | 核销记录ID                                                   |          |
      | SOURCE_CODE         | CSH_PAYMENT                                                  | 来源代码 |
      | GLD_INTERFACE_FLAG  | 现金事物头的GLD_INTERFACE_FLAG                               | 总账标志 |
      | USAGE_CODE          | EMPLOYEE_EXPENSE_CLEARING（报销单费用清算）EMPLOYEE_EXPENSE（报销单费用） | 用途代码 |
  
  - 更新核销事务状态`CshWriteOffServiceImpl.updateTrxWriteStatus`
  
    - 更新现金事物头：
    
      POSTED_FLAG = Y
    
      WRITE_OFF_FLAG =C完全核销\\Y部分核销\\N未核销
    

- 触发事件`CSH_TRANSACTION_POST`

#### 处理状态

  (需要传资金||付款方式不是直接过账)

  - 修改现金事物头`csh_transaction_header`：posted_flag = H
  
  - 修改付款凭证`csh_transaction_account`：gld_interface_flag= H

#### 触发事件

- 触发事件（需要传资金）
  
  - CSH_TRANSACTION_DETAIL_EDIT(插入资金接口表)



## 插入分录表

`gl_account_entry`

| 字段          | 字段值                         | 字段描述 |
| ------------- | ------------------------------ | -------- |
| IMPORTED_FLAG | 同现金事物头gld_interface_flag | 导入标志 |

