# spring boot 入门

## 启动项目

### jar包发布

- pom文件

  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
      <modelVersion>4.0.0</modelVersion>
      <parent>
          <groupId>org.springframework.boot</groupId>
          <artifactId>spring-boot-starter-parent</artifactId>
          <version>2.4.2</version>
          <relativePath/>
      </parent>
      <groupId>com.haoze</groupId>
      <artifactId>hello-spring-boot</artifactId>
      <version>0.0.1-SNAPSHOT</version>
      <name>hello-spring-boot</name>
      <description>Demo project for Spring Boot</description>
      <properties>
          <java.version>1.8</java.version>
      </properties>
      <dependencies>
          <dependency>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-web</artifactId>
          </dependency>
  
          <dependency>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-tomcat</artifactId>
          </dependency>
  
          <dependency>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-test</artifactId>
              <scope>test</scope>
          </dependency>
      </dependencies>
  
      <build>
          <!--设置项目打包之后的名称-->
          <finalName>helloSpringBoot</finalName>
          <plugins>
              <plugin>
                  <groupId>org.springframework.boot</groupId>
                  <artifactId>spring-boot-maven-plugin</artifactId>
              </plugin>
          </plugins>
      </build>
  </project>
  ```

- 项目发布

```shell
#cbsfile-0.0.1-SNAPSHOT.jar			jar包名称
#--spring.profiles.active=dev		指定环境配置文件
java -jar cbsfile-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev

```

### war包发布

当项目还需要使用jsp时可采用此打包方式

- pom文件

  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
      <modelVersion>4.0.0</modelVersion>
      <parent>
          <groupId>org.springframework.boot</groupId>
          <artifactId>spring-boot-starter-parent</artifactId>
          <version>2.4.2</version>
          <relativePath/> <!-- lookup parent from repository -->
      </parent>
      <groupId>com.haoze</groupId>
      <artifactId>hello-spring-boot</artifactId>
      <version>0.0.1-SNAPSHOT</version>
      <name>hello-spring-boot</name>
      <!--修改打包方式为war-->
      <packaging>war</packaging>
      <description>Demo project for Spring Boot</description>
      <properties>
          <java.version>1.8</java.version>
      </properties>
      <dependencies>
          <dependency>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-web</artifactId>
          </dependency>
          <dependency>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-tomcat</artifactId>
              <!--修改tomcat启动依赖的范围,即打包时排除此依赖-->
              <scope>provided</scope>
          </dependency>
          <dependency>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-test</artifactId>
              <scope>test</scope>
          </dependency>
      </dependencies>
  
      <build>
          <!--设置项目打包之后的名称-->
          <finalName>helloSpringBoot</finalName>
          <plugins>
              <plugin>
                  <groupId>org.springframework.boot</groupId>
                  <artifactId>spring-boot-maven-plugin</artifactId>
              </plugin>
          </plugins>
      </build>
  </project>
  ```

- 修改启动配置类

  ```java
  package com.haoze.hellospringboot;
  
  import org.springframework.boot.SpringApplication;
  import org.springframework.boot.autoconfigure.SpringBootApplication;
  import org.springframework.boot.builder.SpringApplicationBuilder;
  import org.springframework.boot.web.servlet.support.SpringBootServletInitializer;
  
  @SpringBootApplication
  public class HelloSpringBootApplication extends SpringBootServletInitializer {
  
      public static void main(String[] args) {
          SpringApplication.run(HelloSpringBootApplication.class, args);
      }
  	/**
  	*打war包需要启动类继承SpringBootServletInitializer 并修改重写configure方法
  	*/
      @Override
      protected SpringApplicationBuilder configure(SpringApplicationBuilder builder) {
          return builder.sources(HelloSpringBootApplication.class);
      }
  
  }
  
  ```

  

## 配置文件

springboot中配置文件有多种加载方式,以下按优先级由低到高,某一属性在多种配置文件里面冲突按优先级生效，没有冲突则会互补。

### @PropertySource @TestPropertySource

在启动类上添加此注解，加载对应配置文件。只能加载properties配置文件

```java
@PropertySource("classpath:appSource.properties")
@TestPropertySource("classpath:appSource.properties")//用于单元测试
```

### 手动加载properties配置

```java
public static void main(String[] args) throws IOException {
	SpringApplication springApplication = new SpringApplication(ExternConfigurationApplication.class);
	
	// 创建Properties
	Properties properties = new Properties();
	// 通过当前类的ClassLoader
	InputStream is= ExternConfigurationApplication.class.getClassLoader()
	.getResourceAsStream("app.properties");
	// 将输入流读取成properties
	properties.load(is);
	
	springApplication.setDefaultProperties(properties);
	springApplication.run(args);
}
```

### 约定配置文件

在springboot框架中，resource文件夹里可以存放配置的文件有两种：properties和yml。官方建议使用yml

多个不同的配置文件按以下顺序加载:

![image-20210215224329948](https://gitee.com/Zeebrary/PicBed/raw/master/img/image-20210215224329948.png)

同一属性存在于不同配置文件，按优先级生效，不同属性多个配置文件之间可以互补。

- 外部约定配置文件加载顺序

springboot 启动还会扫描以下位置的application.properties或者application.yml文件作为Spring boot的默认配置文
件,优先级由低到高:

classpath根目录下的

![image-20210215224737941](https://gitee.com/Zeebrary/PicBed/raw/master/img/image-20210215224737941.png)

classpath根config/

![image-20210215224731170](https://gitee.com/Zeebrary/PicBed/raw/master/img/image-20210215224731170.png)

项目根目录：如果当前项目是继承/耦合 关系maven项目的话，项目根目录=父maven项目的根目录

![image-20210215224802712](https://gitee.com/Zeebrary/PicBed/raw/master/img/image-20210215224802712.png)

项目根目录/config

![image-20210215225005254](https://gitee.com/Zeebrary/PicBed/raw/master/img/image-20210215225005254.png)

#### Profile文件的加载

正式开发中，可能存在很多环境，测试，生产,通过指定不同的profile可以为不同环境配置不同变量。Spring官方给出的语法规则是application-{profile}.properties（.yaml/.yml）。

通过spring.profiles.active来设置有效的profile。<span style="color:#ff0011">注意:此时若不同路径里还有多个配置文件，依然按上面的配置文件顺序加载。</span>

![image-20210216141550874](C:\Users\zee\AppData\Roaming\Typora\typora-user-images\image-20210216141550874.png)

##### **jvm启动参数设置**

`-Dspring.profiles.active=prod`

##### 多profile设置

**yml配置文件通过---来分割不同的profile块:**

```properties
spring:
  profiles:
    active: dev
---
spring:
  config:
    activate:
      on-profile: prod
server:
  port: 8989
---
spring:
  config:
    activate:
      on-profile: dev
server:
  port: 8080
```

### 环境变量设置

在启动项目时设定配置文件路径:

```shell
java ‐jar configuration_file‐0.0.1‐SNAPSHOT.jar ‐‐spring.config.location=D:\config/
```

## 配置文件值注入

### @Value

@Value注解通过SpEL表达式直接注入属性值

```java
@Component
public class User {
	@Value("${user.username}")
	private String username;
	@Value("${user.birthday}")
	private Date birthday;
}
```

yml配置文件中定义:

```yaml
user:
  username: asdf
```

### @ConfigurationProperties

通过此注解批量注入bean的所有属性，此处设置的prefix对应yml文件中的前缀

```java
package com.haoze.hellospringboot.beans;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;
import org.springframework.validation.annotation.Validated;//JSR303数据校验导入

import javax.validation.constraints.NotNull;
import java.util.Date;
import java.util.List;
import java.util.Map;

@Component
@ConfigurationProperties(prefix = "user")
public class User {
	@NotNull
	private String username;
	private Date birthday;
	private Integer age;
	private List<String> hobbies;
	private Map<Integer,String> friends;
}
```

yml配置文件中定义:

```yaml
user:
  username: zxc
  birthday: 2020/01/02
  hobbies: [cat,dog,book]
  friends: {18: zxcasd, 20: zxcz}
```

### 配置文件占位符

在yml配置文件中可以使用占位符赋值:

```yaml
user:
  username: ${user.friends.20} #配置其他属性的引用
  birthday: 2020/01/02
  hobbies: [cat,dog,book]
  friends: {18: zxcasd, 20: zxcz}
  age: ${random.int} 
#还有类似 ${random.value}、${random.int}、${random.long}、${random.int(10)}、${random.int[1024,65536]}

```

### **@Validated**

**可支持JSR303数据校验,需要导入校验启动器**

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
```

## 配置文件可使用值

通过查看自动配置类包含的属性，可快速查看可以在配置文件中能配置的属性。